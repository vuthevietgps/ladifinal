{% extends 'base.html' %}
{% block content %}
<div class="d-flex mb-3 justify-content-between align-items-center">
  <h2><i class="fas fa-rocket"></i> Quản lý Landing Pages</h2>
  <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalCreateLanding">
    <i class="fas fa-plus"></i> Tạo Landing Page Mới
  </button>
</div>

<div class="row mb-3">
  <div class="col-md-12">
    <form class="row row-cols-lg-auto g-2 align-items-center" method="get">
      <div class="col">
        <input type="text" class="form-control" name="q" placeholder="Tìm subdomain" value="{{filters.q}}">
      </div>
      <div class="col">
        <input type="text" class="form-control" name="agent" placeholder="Agent" value="{{filters.agent}}">
      </div>
      <div class="col">
        <select name="status" class="form-select">
          <option value="">Trạng thái</option>
          <option value="active" {% if filters.status=='active' %}selected{% endif %}>Active</option>
          <option value="paused" {% if filters.status=='paused' %}selected{% endif %}>Paused</option>
        </select>
      </div>
      <div class="col">
        <button class="btn btn-secondary">Lọc</button>
      </div>
    </form>
  </div>
</div>

<table class="table table-striped table-bordered">
  <thead class="table-dark">
    <tr>
      <th>ID</th>
      <th>Subdomain</th>
      <th>Agent</th>
      <th>Hotline</th>
      <th>Zalo Phone</th>
      <th>Google Form</th>
      <th>Tracking</th>
      <th>Link</th>
      <th>Trạng thái</th>
      <th>Hành động</th>
    </tr>
  </thead>
  <tbody>
    {% for l in landings %}
    {% if l.page_type == 'landing' %}
    <tr>
      <td>{{l.id}}</td>
      <td><code>{{l.subdomain}}</code></td>
      <td>{{l.agent}}</td>
      <td>{{l.hotline_phone}}</td>
      <td>{{l.zalo_phone}}</td>
      <td>
        {% if l.google_form_link %}
          <a href="{{l.google_form_link}}" target="_blank" class="btn btn-sm btn-outline-info">Form</a>
        {% endif %}
      </td>
      <td>
        <small class="d-block">P: {{l.phone_tracking[:20]}}...</small>
        <small class="d-block">Z: {{l.zalo_tracking[:20]}}...</small>
        <small class="d-block">F: {{l.form_tracking[:20]}}...</small>
      </td>
      <td>
        <a href="/landing/{{l.subdomain}}" target="_blank" class="btn btn-sm btn-outline-success">
          <i class="fas fa-external-link-alt"></i> Xem
        </a>
      </td>
      <td>
        {% if l.status=='active' %}
          <span class="badge bg-success">Active</span>
        {% else %}
          <span class="badge bg-warning text-dark">Paused</span>
        {% endif %}
      </td>
      <td>
        <a class="btn btn-sm btn-outline-primary" href="/admin-panel-xyz123/edit/{{l.id}}">Sửa</a>
        <button data-id="{{l.id}}" class="btn btn-sm btn-outline-warning btn-toggle-status">
          {{'Tạm dừng' if l.status=='active' else 'Kích hoạt'}}
        </button>
        <button data-id="{{l.id}}" class="btn btn-sm btn-outline-danger btn-delete">Xóa</button>
      </td>
    </tr>
    {% endif %}
    {% endfor %}
  </tbody>
</table>

<!-- Modal Create Landing Page -->
<div class="modal fade" id="modalCreateLanding" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-rocket"></i> Tạo Landing Page Mới</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="createLandingForm" enctype="multipart/form-data">
          <input type="hidden" name="page_type" value="landing">
          <input type="hidden" name="upload_type" value="folder">
          
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Subdomain <span class="text-danger">*</span></label>
              <input name="subdomain" id="modalSubdomain" class="form-control" required 
                     pattern="[a-z0-9-]{1,40}" placeholder="ladi1">
              <small class="text-muted">Chỉ chữ thường, số và dấu gạch ngang. VD: ladi1, summer2024</small>
            </div>
            <div class="col-md-6">
              <label class="form-label">Agent</label>
              <select name="agent" class="form-select">
                <option value="">-- Chọn Agent --</option>
                {% for a in agents_list %}
                  <option value="{{a.name}}">{{a.name}}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-12">
              <label class="form-label">File ZIP chứa website <span class="text-danger">*</span></label>
              <input type="file" name="folder_zip" accept=".zip" class="form-control" required>
              <small class="text-muted">Upload file ZIP chứa toàn bộ website (index.html phải ở thư mục gốc)</small>
            </div>
            <div class="col-md-12">
              <label class="form-label">Google Form Link</label>
              <input name="google_form_link" class="form-control" placeholder="https://docs.google.com/forms/...">
            </div>
            <div class="col-12">
              <label class="form-label">Global Site Tag (Google Analytics)</label>
              <textarea name="global_site_tag" class="form-control" rows="3" placeholder="<!-- Global site tag (gtag.js) - Google Analytics -->"></textarea>
            </div>
            <div class="col-md-3">
              <label class="form-label">Phone Tracking</label>
              <input name="phone_tracking" class="form-control" placeholder="JavaScript tracking code">
            </div>
            <div class="col-md-3">
              <label class="form-label">Form Tracking</label>
              <input name="form_tracking" class="form-control" placeholder="Form submission tracking">
            </div>
            <div class="col-md-3">
              <label class="form-label">Zalo/Messenger Tracking</label>
              <input name="zalo_tracking" class="form-control" placeholder="Chat tracking code">
            </div>
            <div class="col-md-3">
              <label class="form-label">Hotline Phone</label>
              <input name="hotline_phone" class="form-control" placeholder="0901234567">
            </div>
            <div class="col-md-3">
              <label class="form-label">Zalo Phone</label>
              <input name="zalo_phone" class="form-control" placeholder="0901234567">
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
        <button class="btn btn-primary" id="btnCreateLandingSubmit">Tạo Landing Page</button>
      </div>
    </div>
  </div>
</div>

<script>
// Load agents for dropdown
async function loadAgents() {
  try {
    const response = await fetch('/api/agents');
    if (response.ok) {
      const data = await response.json();
      const agentSelect = document.querySelector('#modalCreateLanding select[name="agent"]');
      
      if (data.agents && data.agents.length > 0) {
        agentSelect.innerHTML = '<option value="">-- Chọn Agent --</option>';
        data.agents.forEach(agent => {
          const option = document.createElement('option');
          option.value = agent.name;
          option.textContent = agent.name;
          agentSelect.appendChild(option);
        });
      }
    }
  } catch (error) {
    console.error('Error loading agents:', error);
  }
}

// Load agents when modal opens
document.getElementById('modalCreateLanding').addEventListener('shown.bs.modal', loadAgents);

// Landing page creation
document.getElementById('btnCreateLandingSubmit').addEventListener('click', async ()=>{
  const form = document.getElementById('createLandingForm');
  if(!form.reportValidity()) return;
  
  const fd = new FormData(form);
  showLoading('Đang tạo landing page...');
  
  try {
    const r = await fetch('/api/landingpages', {method:'POST', body: fd});
    if(r.ok){ 
      const result = await r.json();
      showSuccess(result.message || 'Tạo landing page thành công!');
      setTimeout(() => location.reload(), 2000);
    } else { 
      hideLoading();
      const error = await r.json();
      alert('Lỗi: ' + (error.message || 'Không thể tạo landing page'));
    }
  } catch(error) {
    hideLoading();
    alert('Lỗi kết nối: ' + error.message);
  }
});

// Status toggle and delete functionality  
document.querySelectorAll('.btn-toggle-status').forEach(btn => {
  btn.addEventListener('click', () => {
    changeStatus(btn.dataset.id, btn.textContent.includes('Tạm dừng') ? 'paused' : 'active');
  });
});

document.querySelectorAll('.btn-delete').forEach(btn => {
  btn.addEventListener('click', () => deleteLanding(btn.dataset.id));
});

// Helper functions
async function changeStatus(id, status){
  showLoading('Đang thay đổi trạng thái...');
  try {
    const r = await fetch(`/api/landingpages/${id}/status`, {
      method:'PATCH', 
      headers:{'Content-Type':'application/json'}, 
      body: JSON.stringify({status})
    });
    if(r.ok) {
      showSuccess('Thay đổi trạng thái thành công!');
      setTimeout(() => location.reload(), 1500);
    } else {
      hideLoading();
      alert('Lỗi đổi trạng thái');
    }
  } catch(error) {
    hideLoading();
    alert('Lỗi kết nối: ' + error.message);
  }
}

async function deleteLanding(id){
  if(!confirm('Bạn có chắc chắn muốn xóa landing page này?')) return;
  showLoading('Đang xóa...');
  try {
    const r = await fetch(`/api/landingpages/${id}`, {method:'DELETE'});
    if(r.ok) {
      showSuccess('Xóa landing page thành công!');
      setTimeout(() => location.reload(), 1500);
    } else {
      hideLoading();
      alert('Lỗi khi xóa');
    }
  } catch(error) {
    hideLoading();
    alert('Lỗi kết nối: ' + error.message);
  }
}
</script>
{% endblock %}