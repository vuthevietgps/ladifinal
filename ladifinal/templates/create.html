{% extends 'base.html' %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3>ThÃªm Landing Page</h3>
  <button class="btn btn-outline-info btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#quickGuide">
    <i class="fas fa-question-circle"></i> HÆ°á»›ng dáº«n nhanh
  </button>
</div>

<!-- Quick Guide Collapse -->
<div class="collapse mb-4" id="quickGuide">
  <div class="card">
    <div class="card-header">
      <h6 class="mb-0"><i class="fas fa-lightbulb"></i> HÆ°á»›ng dáº«n nhanh táº¡o Landing Page</h6>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-12">
          <h6 class="text-success">ğŸ“ Upload Folder (Duy nháº¥t)</h6>
          <ul class="small mb-3">
            <li>Upload file <code>.zip</code> hoÃ n chá»‰nh</li>
            <li>Chá»©a CSS, JS, áº£nh vÃ  táº¥t cáº£ assets</li>
            <li>PhÃ¹ há»£p cho má»i loáº¡i website</li>
          </ul>
        </div>
      </div>
      <div class="alert alert-warning small mb-0">
        <i class="fas fa-exclamation-triangle"></i>
        <strong>LÆ°u Ã½ quan trá»ng:</strong>
        <ul class="mb-0">
          <li>Äáº£m báº£o file <code>index.html</code> náº±m á»Ÿ thÆ° má»¥c gá»‘c ZIP</li>
          <li>DÃ¹ng Ä‘Æ°á»ng dáº«n tÆ°Æ¡ng Ä‘á»‘i: <code>images/logo.png</code> (khÃ´ng cÃ³ dáº¥u <code>/</code> Ä‘áº§u)</li>
          <li>Kiá»ƒm tra file hoáº¡t Ä‘á»™ng trÃªn local trÆ°á»›c khi upload</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<form action="/api/landingpages" method="post" enctype="multipart/form-data" class="mt-3" id="createForm">
  <fieldset class="border rounded p-3 mb-3">
    <legend class="float-none w-auto px-2 small">ThÃ´ng tin chung</legend>
    <div class="row g-3">
      <div class="col-md-3">
        <label class="form-label">Loáº¡i giao diá»‡n</label>
        <select name="page_type" class="form-select" id="pageTypeSelect">
          <option value="landing" selected>Trang ladipage</option>
          <option value="homepage">Trang chá»§</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Subdomain (vd: ladi1)</label>
        <input name="subdomain" class="form-control" required pattern="[a-z0-9-]{1,40}" placeholder="ladi1" id="subdomainInput">
      </div>
      <div class="col-md-3">
        <label class="form-label">Agent</label>
        <select name="agent" class="form-select">
          <option value="">-- Chá»n Agent --</option>
          {% for a in agents_list %}
            <option value="{{a.name}}">{{a.name}}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-6">
        <label class="form-label">Google Form Link</label>
        <input name="google_form_link" class="form-control" placeholder="https://docs.google.com/forms/...">
      </div>
    </div>
  </fieldset>
  
  <!-- Folder Upload (Default) -->
  <fieldset class="border rounded p-3 mb-3">
    <legend class="float-none w-auto px-2 small">Upload folder website</legend>
    <!-- Hidden field to always use folder upload -->
    <input type="hidden" name="upload_type" value="folder">
    <div class="row g-3">
      <div class="col-md-12">
        <label class="form-label">File ZIP chá»©a folder website</label>
        <input type="file" name="folder_zip" accept=".zip" class="form-control">
        <div class="alert alert-info mt-2">
          <h6><i class="fas fa-info-circle"></i> Cáº¥u trÃºc ZIP chuáº©n:</h6>
          <div class="row">
            <div class="col-md-6">
              <strong class="text-success">âœ… ÄÃšNG:</strong>
              <pre class="small bg-light p-2 rounded mt-1">your-site.zip
â”œâ”€â”€ index.html
â”œâ”€â”€ css/
â”‚   â””â”€â”€ style.css
â”œâ”€â”€ js/
â”‚   â””â”€â”€ main.js
â””â”€â”€ images/
    â””â”€â”€ logo.png</pre>
            </div>
            <div class="col-md-6">
              <strong class="text-danger">âŒ SAI:</strong>
              <pre class="small bg-light p-2 rounded mt-1">your-site.zip
â””â”€â”€ your-site/
    â”œâ”€â”€ index.html
    â”œâ”€â”€ css/
    â””â”€â”€ images/</pre>
              <small class="text-muted">*Há»‡ thá»‘ng sáº½ tá»± Ä‘á»™ng sá»­a lá»—i nÃ y</small>
            </div>
          </div>
          <hr class="my-2">
          <ul class="mb-0 small">
            <li><strong>File báº¯t buá»™c:</strong> <code>index.html</code> á»Ÿ thÆ° má»¥c gá»‘c</li>
            <li><strong>Tá»‘i Ä‘a:</strong> 500 file, 500MB tá»•ng dung lÆ°á»£ng, 50MB/file</li>
            <li><strong>Há»— trá»£:</strong> .html, .css, .js, .png, .jpg, .gif, .svg, .webp, .ico, .txt, .json</li>
            <li><strong>ÄÆ°á»ng dáº«n:</strong> DÃ¹ng <code>images/logo.png</code> thay vÃ¬ <code>/images/logo.png</code></li>
          </ul>
        </div>
      </div>
    </div>
  </fieldset>
  
  <fieldset class="border rounded p-3 mb-3">
    <legend class="float-none w-auto px-2 small">Analytics & Tracking</legend>
    <div class="row g-3">
      <div class="col-md-4">
        <label class="form-label"><i class="fab fa-google"></i> Google Analytics 4 ID</label>
        <input name="ga_tracking_id" class="form-control" placeholder="G-XXXXXXXXXX">
        <small class="text-muted">VÃ­ dá»¥: G-1A2B3C4D5E</small>
      </div>
      <div class="col-md-4">
        <label class="form-label"><i class="fab fa-facebook"></i> Facebook Pixel ID</label>
        <input name="fb_pixel_id" class="form-control" placeholder="1234567890123456">
        <small class="text-muted">Pixel ID tá»« Facebook Events Manager</small>
      </div>
      <div class="col-md-4">
        <label class="form-label"><i class="fab fa-tiktok"></i> TikTok Pixel ID</label>
        <input name="tiktok_pixel_id" class="form-control" placeholder="XXXXXXXXXXXXXXXXXX">
        <small class="text-muted">Pixel ID tá»« TikTok Events Manager</small>
      </div>
      <div class="col-12">
        <label class="form-label">Global Site Tag (Legacy - Optional)</label>
        <textarea name="global_site_tag" class="form-control" rows="3" placeholder="<!-- Custom tracking code -->"></textarea>
        <small class="text-muted">DÃ nh cho tracking code tÃ¹y chá»‰nh khÃ¡c</small>
      </div>
      <div class="col-md-4">
        <label class="form-label">Phone Tracking</label>
        <input name="phone_tracking" class="form-control" placeholder="MÃ£ phone tracking">
      </div>
      <div class="col-md-4">
        <label class="form-label">Form Tracking</label>
        <input name="form_tracking" class="form-control" placeholder="MÃ£ form tracking">
      </div>
      <div class="col-md-4">
        <label class="form-label">Zalo/Messenger Tracking</label>
        <input name="zalo_tracking" class="form-control" placeholder="MÃ£ zalo/messenger">
      </div>
      <div class="col-md-4">
        <label class="form-label">Hotline Phone</label>
        <input name="hotline_phone" class="form-control" placeholder="Sá»‘ hotline hiá»ƒn thá»‹">
      </div>
      <div class="col-md-4">
        <label class="form-label">Zalo Phone</label>
        <input name="zalo_phone" class="form-control" placeholder="Sá»‘ Zalo">
      </div>
    </div>
  </fieldset>
  <div class="mt-3">
    <button class="btn btn-primary">LÆ°u</button>
    <a href="/admin-panel-xyz123/" class="btn btn-secondary">Há»§y</a>
    <a href="/static/docs/HUONG-DAN-TAO-FOLDER-LANDING.md" class="btn btn-outline-info ms-2" target="_blank">
      <i class="fas fa-book"></i> HÆ°á»›ng dáº«n chi tiáº¿t
    </a>
  </div>
</form>
<script>
  // Make folder upload required
  document.querySelector('input[name="folder_zip"]').required = true;

  // Toggle subdomain required based on page type
  const pageTypeSelect = document.getElementById('pageTypeSelect');
  const subdomainInput = document.getElementById('subdomainInput');
  function updateSubdomainRequirement(){
    const isHomepage = pageTypeSelect.value === 'homepage';
    subdomainInput.required = !isHomepage;
    subdomainInput.disabled = isHomepage;
    subdomainInput.placeholder = isHomepage ? 'KhÃ´ng cáº§n cho Trang chá»§' : 'ladi1';
  }
  pageTypeSelect.addEventListener('change', updateSubdomainRequirement);
  updateSubdomainRequirement();

  const form = document.getElementById('createForm');
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const fd = new FormData(form);
    
    // Show loading overlay for folder upload
    showLoading('Äang upload folder...');
    
    try {
      const r = await fetch('/api/landingpages', {method:'POST', body: fd});
      if(r.ok){
        const result = await r.json();
        showSuccess(result.message || 'Táº¡o landing page thÃ nh cÃ´ng!');
        // Redirect after showing success message
        setTimeout(() => {
          window.location.href = '/admin-panel-xyz123/';
        }, 2000);
      } else {
        hideLoading();
        const j = await r.json().catch(()=>({error:'Lá»—i khÃ´ng xÃ¡c Ä‘á»‹nh'}));
        alert('Lá»—i: ' + (j.error || 'KhÃ´ng thá»ƒ upload'));
      }
    } catch (error) {
      hideLoading();
      alert('Lá»—i káº¿t ná»‘i: ' + error.message);
    }
  })
</script>
{% endblock %}